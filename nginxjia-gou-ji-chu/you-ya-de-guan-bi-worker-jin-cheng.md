# 优雅的关闭worker进程

所谓优雅的关闭 , 是对worker进程而言的 . 因为只有worker进程才会处理请求 . 如果在处理一个连接的时候 , 不管连接此时对于请求是怎样一个作用 , 直接去关闭连接 , 就会导致用户收到错误 . 所以优雅的关闭就是指Nginx的worker进程可以识别出 , 当前的连接有没有处理请求 , 如果没有再关闭连接 .

但是 , 对于有些请求 , Nginx是做不到前面所说的优雅的 . 比如 , 当Nginx代理websocket协议时 , 在websocket后面通讯的frame帧里 , Nginx是不解析它的帧的 , 所以这个时候是没办法优雅的 . Nginx在做TCP/UDP反向代理的时候 , 也是没有办法识别一个请求需要经历多少报文才算是结束 .

所以这里所说的优雅的关闭 , 主要是针对的HTTP请求 .

#### 优雅的关闭的流程

* 设置定时器 - worker\_shutdown\_timeout , 设置了之后会加一个标志位表示已经开始优雅的关闭了 . 
* 关闭监听句柄 , 保证我所在的worker进程不会再去处理新的连接了 . 
* 接下来检查连接池 , 关闭空闲连接 . 
* 在循环中等待全部连接关闭 , 这里的全部连接关闭时间可能会超过第一步设定的时间 , 此时这些连接就会被强制关闭 , 也就是说优雅的关闭只完成了一半 , 有一部分连接变成了立即停止 . 
* 退出进程

很多时候 , 我们都会使用到优雅的特性 , 在这个优雅特性失效时 , 我们需要考虑nginx是否有能力去判断一个连接此时应当被正确的关掉 . 或者说 , 如果出现了错误 , 有一些模块或者有一些客户端 , 不能正常的处理请求时 , nginx需要有一些例外的措施 , 比如worker\_shutdown\_timeout配置 , 来保证nginx老的worker进程可以正常的退出 . 

